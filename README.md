## âœ… `semantra/app` ã®ã‚³ã‚¢ç›®çš„ï¼ˆãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹ï¼‰

1. **å˜ãªã‚‹ API/UI ã®é››å½¢ã§ã¯ãªã„**

   - ç©ºé–“æƒ…å ±ï¼ˆåœ°ç‰©ï¼‰ã‚’ã€Œæ„å‘³æ§‹é€ ä½“ã€ã¨ã—ã¦ç™»éŒ² â†’ æ¤œç´¢ â†’ ç·¨é›† â†’2D/3D åˆ‡æ›¿ã¾ã§ã‚’ãƒ¯ãƒ³ã‚¹ãƒˆãƒƒãƒ—ã§å›ã™å®Ÿè¨¼ã€‚

2. **Sony ã® RDC_R0119 ã®å½¹å‰²ã«æ²¿ã†å¼·ã¿**

   - Mapray ã‚„è¡›æ˜Ÿãƒ‡ãƒ¼ã‚¿ãªã©å¤šæ§˜ãª GIS ã‚’ã€Œæ§‹é€ ä½“åŒ–ã€ã—ã€æ„å‘³æ¤œç´¢å¯èƒ½ãªå½¢ã§å³å¯è¦–åŒ–ã§ãã‚‹ã€‚

## âœ… Semantra å½¹å‰²ãƒãƒƒãƒ”ãƒ³ã‚°

| ã‚µãƒ¼ãƒ“ã‚¹         | ä¸»ãªå½¹å‰²               | ä¸»ãªè²¬å‹™                                                          | é–¢é€£ã‚¹ãƒˆã‚¢         | ãƒã‚¤ãƒ³ãƒˆ                   |
| ---------------- | ---------------------- | ----------------------------------------------------------------- | ------------------ | -------------------------- |
| **db (PostGIS)** | çœŸç†å€¤ã‚¹ãƒˆã‚¢           | ç©ºé–“æ§‹é€ ã®ç®¡ç†ï¼ˆGEOMETRYï¼‰<br>æ„å‘³å±æ€§ï¼ˆJSONBï¼‰<br>ã‚¿ã‚°ãƒã‚¹ã‚¿ãƒ¼   | PostGIS            | SRID 4326 + GIST + GIN     |
| **api**          | Command & Query API    | REST (CQRS) ã‚’æä¾›<br>æ›¸è¾¼ã¿ã¯ PostGIS<br>èª­ã¿è¾¼ã¿ã¯ ES + PostGIS | PostGIS + ES       | Echo / Clean Arch          |
| **sync**         | Sync Worker            | Redis Streams â†’ ES ã¸éåŒæœŸåŒæœŸ<br>Bulk Index & ã‚¨ãƒ©ãƒ¼æ™‚ DLQ      | Redis Streams + ES | Eventual Consistency       |
| **es**           | æ¤œç´¢ãƒ“ãƒ¥ãƒ¼             | æ„å‘³ãƒ»ã‚¿ã‚°å…¨æ–‡æ¤œç´¢<br>è¤‡åˆæ¡ä»¶ã®é«˜é€Ÿæ¤œç´¢                          | Elasticsearch      | Bulk API / Single-node PoC |
| **redis**        | Event Store<br>Pub/Sub | PostGIS å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸­ç¶™<br>ã‚­ãƒ£ãƒƒã‚·ãƒ¥/é€šçŸ¥ã«ã‚‚æ‹¡å¼µå¯           | Redis Streams      | Stream TTL / DLQ           |
| **web**          | Frontend BFF / UI      | Next.js App Router<br>2D/3D åœ°å›³ & æ§‹é€ ä½“ç·¨é›†                     | API (BFF) çµŒç”±     | MapLibre + Cesium          |
| **gate**         | API Gateway            | å¤–éƒ¨ã‹ã‚‰ã®å…¥å£ã‚’ä¸€å…ƒåŒ–<br>BFF/Bulk/å¤–éƒ¨ API é€£æºã®å°†æ¥æ€§          | ã™ã¹ã¦ã® API       | Declarative Config         |
| **bff**          | BFF å°‚ç”¨å±¤             | API/Query ã®é›†ç´„<br>èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†                | API + Web          | Graphql                    |

---

## âœ… ç‰©ç†ã‚¤ãƒ¡ãƒ¼ã‚¸

```plaintext
[Browser]
  â†“ HTTPS
[gate (Kong)]
  â†“ route
[bff (optional)] (Next.js API routes ã§ã‚‚è‰¯ã„)
  â†“ REST/GraphQL
[api]
  â”œâ”€ Command â†’ PostGIS â†’ Redis Streams â†’ [sync] â†’ ES
  â””â”€ Query â†’ ES â†’ (PostGIS for precise geom)

[sync]
  â””â”€ Redis Streams subscribe â†’ ES Bulk Index

[redis]
  â””â”€ Streams, PubSub

[es]
  â””â”€ é«˜é€Ÿæ„å‘³æ¤œç´¢
```

---

## âœ… Semantra DB ä»•æ§˜

### ğŸ¯ **ç›®çš„**

ãƒªã‚¢ãƒ«ç©ºé–“ã‚’ã€Œæ„å‘³ Ã— ä½ç½® Ã— æ™‚é–“è»¸ã€ã§æ‰ãˆã€
**ç©ºé–“æ¤œç´¢ï¼ˆPostGISï¼‰** ã¨ **æ„å‘³æ¤œç´¢ï¼ˆElasticsearchï¼‰** ã‚’é€£æºã•ã›ã€
**ç¶™ç¶šçš„ã«ç·¨é›†ãƒ»ç”Ÿæˆãƒ»é…ä¿¡ã§ãã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ„ã‚¤ãƒ³åŸºç›¤** ã‚’ OSS ã§å®Ÿè¨¼ã™ã‚‹ã€‚

---

### âœ… **å½¹å‰²åˆ†æ‹…ã®è¨­è¨ˆ**

| ã‚¹ãƒˆã‚¢            | ä¸»ãªè²¬å‹™                                                                               | æŠ€è¡“è¦ç‚¹                                                         |
| ----------------- | -------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| **PostGIS**       | åœ°ç‰©ã®æ­£ç¢ºãªä½ç½®æƒ…å ±ã¨ãƒˆãƒãƒ­ã‚¸ãƒ¼ã‚’æ ¼ç´ã€‚BBOXã€è¿‘å‚ã€äº¤å·®ã€åŒ…å«ç­‰ã®å³å¯†ç©ºé–“æ¼”ç®—ã‚’æ‹…ã†ã€‚ | GIST ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ç©ºé–“å‹ SRID:4326ã€ä¸€æ„è­˜åˆ¥å­ã§ã‚¹ã‚±ãƒ¼ãƒ«å¯¾å¿œã€‚  |
| **JSONB**         | å€‹åˆ¥ Feature ãŒæŒã¤æŸ”è»Ÿãªå±æ€§ï¼ˆä¾‹ï¼šç‰©ç†çš„å±æ€§ãƒ»çŠ¶æ…‹ãƒ»æ‹¡å¼µãƒ¡ã‚¿ï¼‰ã€‚                      | GIN ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§å±æ€§ãƒ‘ã‚¹æ¤œç´¢ã‚’é«˜é€ŸåŒ–ã—ã€ã‚¹ã‚­ãƒ¼ãƒé€²åŒ–ã«è€ãˆã‚‹ã€‚ |
| **Tag ç®¡ç†**      | å¤šå¯¾å¤šãƒ†ãƒ¼ãƒ–ãƒ«ã§æŸ”è»Ÿã«ã‚¿ã‚°ã‚’ä»˜ä¸ã€‚æ§‹é€ ä½“ã®æ„å‘³æŠ½è±¡åŒ–ã‚’è£œå®Œã—ã€ã‚¯ã‚¨ãƒªè² è·ã‚’åˆ†æ•£ã€‚       | ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£åˆ¶å¾¡ã«ã‚ˆã‚Šæ„å‘³è§£åƒåº¦ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ä¸¡ç«‹ã€‚     |
| **Elasticsearch** | æ„å‘³ãƒ»ã‚¿ã‚°ã®å…¨æ–‡æ¤œç´¢ãƒ»è¤‡åˆæ¡ä»¶æ¤œç´¢ã‚’æ‹…å½“ã€‚PostGIS ã¨ã®æ•´åˆã‚’éåŒæœŸã§æ‹…ä¿ã€‚             | Bulk API & Eventual Consistency ã§ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’ç¢ºä¿ã€‚           |

---

### âœ… **ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦**

| ãƒ†ãƒ¼ãƒ–ãƒ«å           | æ©Ÿèƒ½                                                  |
| -------------------- | ----------------------------------------------------- |
| **st01_model**       | åœ°ç‰©ã‚¿ã‚¤ãƒ—ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ï¼ˆä¾‹: building, route, landmarkï¼‰ |
| **st02_feature**     | åœ°ç‰©æœ¬ä½“ï¼ˆä½ç½®ï¼‹æ„å‘³å±æ€§ï¼‹æ™‚ç³»åˆ—æƒ…å ±ï¼‰                |
| **st03_tag**         | æ„å‘³ã‚’æŠ½è±¡åŒ–ã™ã‚‹ãƒ©ãƒ™ãƒ«ç¾¤ï¼ˆè‡ªç”±ã«è¿½åŠ å¯èƒ½ï¼‰            |
| **st04_feature_tag** | Feature Ã— Tag ã®å¤šå¯¾å¤šé–¢é€£ä»˜ã‘                        |
| **st05_feature_log** | æ“ä½œãƒ­ã‚°ï¼ˆå°†æ¥ã®å·®åˆ†æ›´æ–°ãƒ»å±¥æ­´è¿½è·¡ã«å‚™ãˆã‚‹ï¼‰          |

---

### âœ… **ER å›³ (è«–ç†ãƒ¢ãƒ‡ãƒ«)**

```mermaid
erDiagram
  st01_model {
    UUID st01_model_id PK
    TEXT st01_model_name
  }

  st02_feature {
    UUID st02_feature_id PK
    UUID st01_model_id FK
    GEOMETRY st02_geom
    JSONB st02_props
    TIMESTAMPTZ st02_obs_time
    TIMESTAMPTZ st02_created_at
    TIMESTAMPTZ st02_updated_at
  }

  st03_tag {
    UUID st03_tag_id PK
    TEXT st03_tag_name
  }

  st04_feature_tag {
    UUID st02_feature_id PK
    UUID st03_tag_id PK
  }

  st05_feature_log {
    BIGSERIAL st05_log_id PK
    UUID st02_feature_id FK
    TEXT st05_op
    JSONB st05_before
    JSONB st05_after
    TIMESTAMPTZ st05_ts
  }

  st01_model ||--o{ st02_feature : contains
  st02_feature ||--o{ st04_feature_tag : "labeled"
  st03_tag ||--o{ st04_feature_tag : "tagged"
  st02_feature ||--o{ st05_feature_log : "has logs"
```

---

### âœ… **è¨­è¨ˆå“²å­¦**

- **æ§‹é€ åŒ– Ã— æ„å‘³æ§‹é€ ã®äºŒé‡åŒ–ã§è€éšœå®³æ€§ã‚’æ‹…ä¿**
  â†’ PostGIS ã¯ç©ºé–“æ§‹é€ ã®çœŸç†å€¤ã€‚Elastic ã¯æ„å‘³æ¤œç´¢ã®é«˜å¯ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚

- **UUID v4 ã«ã‚ˆã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ„æ€§**
  â†’ ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®ç©ºé–“ãƒ»æ„å‘³åŒæœŸã«å¼·ã„ã€‚

- **å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨™æº–åŒ–**
  â†’ å°†æ¥ã®å·®åˆ†æ›´æ–°ã€Undo/Redoã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ç®¡ç†ã«å¯¾å¿œã€‚

- **Semantic Ã— Terra Ã— Time è»¸ã«æ‹¡å¼µå¯èƒ½**
  â†’ ä¾‹ãˆã°ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿é€£æºã€LiDAR ç‚¹ç¾¤ã‚’æ§‹é€ ä½“åŒ–ã—å±¥æ­´ä»˜ãã§ä¿æŒã€‚

- **Elastic ã¨ã¯éåŒæœŸ Eventual Consistency**
  â†’ æ›¸è¾¼ã¿ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’æŠ‘ãˆã¤ã¤å…¨æ–‡æ¤œç´¢ã®å³æ™‚æ€§ã‚’ä¸¡ç«‹ã€‚

### ğŸ“‘ Semantra API ä»•æ§˜æ›¸ v0.9

_(ç¯„å›²ï¼`api â†” db`ã€‚Sync / BFF ã¯å¯¾è±¡å¤–)_

| #   | ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹       | HTTP Method / Path               | èª¬æ˜                                                 | ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                                       | ãƒªã‚½ãƒ¼ã‚¹è²¬å‹™          | æˆ»ã‚Šå€¤(200)                     |
| --- | ------------------ | -------------------------------- | ---------------------------------------------------- | ---------------------------------------------------- | --------------------- | ------------------------------- |
| C-1 | **åœ°ç‰©ç™»éŒ²**       | **POST `/features`**             | GeoJSON+å±æ€§ã‚’ç™»éŒ²ã— `st02_feature` ã‚’ INSERT        | Body = { model, geometry, props?, tags?, obs_time? } | **Command**           | `{ id }` + ä½œæˆæƒ…å ±             |
| C-2 | **åœ°ç‰©æ›´æ–°**       | **PATCH `/features/{id}`**       | æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’éƒ¨åˆ†æ›´æ–°ã€å±¥æ­´ã‚’ `st05_feature_log` ã¸ | Body = æ›´æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰                                | Command               | æ›´æ–°å¾Œ JSON                     |
| C-3 | **åœ°ç‰©å‰Šé™¤**       | **DELETE `/features/{id}`**      | `st02_feature` è«–ç†å‰Šé™¤ (is_deleted) or ç‰©ç†å‰Šé™¤     |                                                      | Command               | `{ deleted: true }`             |
| C-4 | **ãƒ¢ãƒ‡ãƒ«ç™»éŒ²**     | **POST `/models`**               | `st01_model` ã«ã‚¿ã‚¤ãƒ—è¿½åŠ                             | Body = { name }                                      | Command               | ãƒ¢ãƒ‡ãƒ« JSON                     |
| C-5 | **ã‚¿ã‚°ç™»éŒ²**       | **POST `/tags`**                 | `st03_tag` ã«æ–°è¦ã‚¿ã‚°è¿½åŠ                             | Body = { name }                                      | Command               | ã‚¿ã‚° JSON                       |
| Q-1 | **åœ°ç‰©è©³ç´°å–å¾—**   | **GET `/features/{id}`**         | PK ã§å–å¾—ï¼ˆPostGISï¼‰                                 | `include_history`=bool                               | **Query(DB)**         | Feature + tags (+history)       |
| Q-2 | **BBOX ç©ºé–“æ¤œç´¢**  | **GET `/features`**              | `bbox` only â‡’ PostGIS `ST_Intersects`                | `bbox=minLon,minLat,maxLon,maxLat`<br>`model?`       | Query(DB)             | GeoJSON FeatureCollection       |
| Q-3 | **æ„å‘³æ¤œç´¢**       | **GET `/search`**                | ES å…¨æ–‡ï¼‹ã‚¿ã‚°ï¼‹ BBOX                                 | `q=text` `tags=tag1,tag2?` `bbox?`                   | **Query(ESâ†’DB clip)** | FeatureCollection               |
| Q-4 | **ã‚¿ã‚°ä¸€è¦§**       | **GET `/tags`**                  | `st03_tag` å…¨ä»¶                                      | `model?` ãƒ•ã‚£ãƒ«ã‚¿                                    | Query(DB)             | `[ { id, name } ]`              |
| Q-5 | **ãƒ¢ãƒ‡ãƒ«ä¸€è¦§**     | **GET `/models`**                | `st01_model` å…¨ä»¶                                    |                                                      | Query(DB)             | `[ { id, name } ]`              |
| Q-6 | **å±¥æ­´å–å¾—**       | **GET `/features/{id}/history`** | å¤‰æ›´å±¥æ­´ã‚’æ™‚ç³»åˆ—ã§è¿”å´                               | `limit?` `since?`                                    | Query(DB)             | `[ { ts, op, before, after } ]` |
| S-1 | **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯** | **GET `/healthz`**               | Liveness / Readiness                                 |                                                      | Infra                 | `"ok"`                          |

---
